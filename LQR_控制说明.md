# LQR控制系统使用说明

## 概述
已成功将您的双轮自平衡机器人从PID控制升级为LQR（线性二次型调节器）控制。LQR控制器相比PID控制器具有以下优势：

### LQR控制器优势
1. **最优控制**: LQR基于最优控制理论，能够在保证系统稳定性的同时最小化能耗
2. **多状态反馈**: 同时考虑角度、角速度、位置和速度四个状态变量，控制更精确
3. **抗干扰能力强**: 对系统参数变化和外部干扰具有更好的鲁棒性
4. **收敛速度快**: 理论上具有更快的收敛速度和更小的超调

## 系统状态变量
LQR控制器监控以下四个状态：
- **角度** (pitch): 机器人倾斜角度
- **角速度** (gyroY): 机器人倾斜角速度  
- **位置**: 机器人移动位置（通过轮速积分）
- **速度**: 机器人移动速度（轮子平均速度）

## 控制模式切换
### 通过串口命令切换：
- 发送 `lqr` + 回车：切换到LQR控制模式
- 发送 `pid` + 回车：切换到PID控制模式

### 代码中默认设置：
在 `main.cpp` 中，`use_lqr_control = true` 表示默认使用LQR控制

## LQR参数调节
### 权重矩阵说明：
```cpp
// 状态权重矩阵Q的对角元素
Q[0][0] = 100.0;  // 角度权重 - 值越大越注重保持直立
Q[1][1] = 10.0;   // 角速度权重 - 值越大越注重抑制震荡  
Q[2][2] = 1.0;    // 位置权重 - 值越大越注重保持位置
Q[3][3] = 1.0;    // 速度权重 - 值越大越注重速度稳定

// 输入权重矩阵R
R[0][0] = 0.1;    // 控制输入权重 - 值越大越注重节能
```

### 反馈增益矩阵K：
当前使用的预计算增益：
```cpp
K[0][0] = -31.62;  // 角度反馈增益
K[0][1] = -4.47;   // 角速度反馈增益  
K[0][2] = -1.73;   // 位置反馈增益
K[0][3] = -2.24;   // 速度反馈增益
```

### 参数调节函数：
```cpp
lqr_tune_parameters(q_angle, q_angular_vel, q_position, q_velocity, r_input);
```

## 调试信息
启用 `testdataprint()` 函数后，串口监视器会显示：
- 当前控制模式（LQR或PID）
- 机器人角度、角速度、高度
- 相应控制器的输出值

## 注意事项
1. **初次使用**: 建议先在较低高度（ZeparamremoteValue < 80）下测试
2. **参数调节**: 如需调节，建议先调整Q矩阵权重，然后重新计算K矩阵
3. **安全限制**: LQR控制器同样受到 `speed_limit_lqr` 的限制（默认为5）
4. **高度自适应**: 系统在高机身时（ZeparamremoteValue > 80）会自动增强控制增益

## 故障排除
- 如果机器人不稳定，可以增加角度权重 Q[0][0]
- 如果震荡严重，可以增加角速度权重 Q[1][1]  
- 如果位置漂移，可以增加位置权重 Q[2][2]
- 如果控制过于激进，可以增加输入权重 R[0][0]

## 未来扩展
- 可以实现自适应LQR，根据系统状态动态调整权重矩阵
- 可以添加卡尔曼滤波器进行状态估计
- 可以实现在线Riccati方程求解，实现真正的在线参数调节 